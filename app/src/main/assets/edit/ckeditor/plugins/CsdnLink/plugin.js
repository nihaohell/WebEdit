CKEDITOR.plugins.add("CsdnLink",{icons:"csdnlink",icontype:".svg",iconoffset:"center",iconbgsize:"16px",hidpi:!1,init:function(e){function m(a,c){var b=e.config.csdnlink&&e.config.csdnlink.extraHeight,b=parseInt(b)?b:0,d=CKEDITOR.instances.editor.container.getDocumentPosition(),h=e.container.findOne(".cke_contents").getDocumentPosition(),g=e.container.findOne(".cke_wysiwyg_frame").$,f=window.getComputedStyle(g).paddingLeft.replace("px",""),f=f?parseInt(f):0,g=h.y-d.y+c.element.$.offsetHeight+a.y,
f=h.x+a.x+f+c.element.$.offsetWidth/2-8,n=0,n=document.scrollingElement.clientHeight-h.y-a.y+document.scrollingElement.scrollTop-b;return 62>n?(g=h.y-d.y+a.y-16,{type:"top",top:g,left:f}):{type:"bottom",top:g,left:f}}function p(a,c,b){a=m(a,b);var d=CKEDITOR.dom.element.createFromHtml('\x3cdiv class\x3d"cke_editor_link-pop-box cke_editor_link-pop-box_'+a.type+'" contenteditable\x3d"false" style\x3d"top:'+a.top+"px;left:"+a.left+'px;"\x3e\x3cspan class\x3d"link-pop-arrow link-pop-arrow--'+a.type+'"\x3e\x3c/span\x3e\x3cdiv class\x3d"link-pop-content"\x3e\x3ca target\x3d"_blank" href\x3d"'+
c.url+'" class\x3d"link-pop-link"\x3e'+c.url+'\x3c/a\x3e\x3cbutton type\x3d"button" class\x3d"btn-link-edit" title\x3d"编辑"\x3e\x3csvg xmlns\x3d"http://www.w3.org/2000/svg" xmlns:xlink\x3d"http://www.w3.org/1999/xlink" t\x3d"1630393775738" class\x3d"icon" viewBox\x3d"0 0 1024 1024" version\x3d"1.1" p-id\x3d"4960" width\x3d"200" height\x3d"200"\x3e\x3cpath d\x3d"M889.27232 38.765714l96.036571 95.524572a132.534857 132.534857 0 0 1 0 187.099428l-663.405714 517.193143A131.657143 131.657143 0 0 1 228.060891 877.714286H44.106606A44.178286 44.178286 0 0 1 0.001463 833.462857V649.508571c-0.146286-35.108571 13.897143-68.754286 38.765714-93.549714L702.172891 38.692571a132.315429 132.315429 0 0 1 187.099429 0z m-51.712 51.712a59.245714 59.245714 0 0 0-77.019429-5.705143l-13.385142 11.702858-658.724572 513.462857-3.218286 3.657143a58.221714 58.221714 0 0 0-11.556571 28.086857L73.14432 649.508571l-0.073143 154.916572H228.207177a58.514286 58.514286 0 0 0 35.913143-12.141714l12.8-11.337143 658.432-513.389715 3.876571-4.388571a59.392 59.392 0 0 0 0.219429-70.436571l-5.705143-6.582858-96.182857-95.670857zM987.430034 950.857143a36.571429 36.571429 0 1 1 0 73.142857H36.572891a36.571429 36.571429 0 1 1 0-73.142857h950.857143z" p-id\x3d"4961"/\x3e\x3c/svg\x3e\x3c/button\x3e\x3cbutton type\x3d"button" class\x3d"btn-link-dialog"\x3e'+
(c.isCard?"切换为链接":"切换为卡片")+"\x3c/button\x3e\x3c/div\x3e\x3c/div\x3e");d.findOne("button.btn-link-edit").on("click",function(){b.fire("doubleclick");d.remove();d=null});d.findOne("button.btn-link-dialog").on("click",function(){if(c.isCard)b.setData("isCard",!1),b.removeClass("has-card"),b.element.setAttribute("contenteditable",!0),b.element.setText(c.text),e.fire("saveSnapshot");else{b.setData("isCard",!0);var a=k.output(b.data);b.element.setHtml(a);b.addClass("has-card");e.fire("saveSnapshot");1}});
CKEDITOR.instances.editor.container.append(d);return d}function q(a,c){e.config.csdnlink&&e.config.csdnlink.getInfoUrl&&CKEDITOR.ajax.post(e.config.csdnlink.getInfoUrl,JSON.stringify({url:a}),"application/json",function(b){if(b&&(b=JSON.parse(b),200===b.code)){if(b.data.title){c.setData("text",b.data.title);var d=c.element.getDocumentPosition(),d=m(d,c);f[c.data.id].setStyles({top:d.top+"px",left:d.left+"px"})}else""===c.data.title&&c.setData("text",a);b.data.icon&&c.setData("icon",b.data.icon);b.data.description&&
c.setData("desc",b.data.description)}})}function r(){var a=window.crypto||window.msCrypto,c="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),b=c.length;Uint32Array.prototype.cl_map=function(a){for(var b=0,c=this.length,d=Array(c);b<c;b++)d[b]=a(this[b],b,this);return d};var d=new Uint32Array(6);a.getRandomValues(d);return d.cl_map(function(a){return c[a%b]}).join("")}e.addCommand("csdnlink",new CKEDITOR.dialogCommand("csdnlinkDialog"));e.ui.addButton("CsdnLink",{label:"链接",
icons:"csdnlink",command:"csdnlink",toolbar:"insert,13"});var f={},t=CKEDITOR.getUrl(this.path+"icons/icon-default.png");CKEDITOR.dialog.add("csdnlinkDialog",this.path+"dialogs/csdnlink.js");var l=function(a){return'\x3ca class\x3d"link-csdn" href\x3d"{url}" title\x3d{text}\x3e\x3cspan class\x3d"link-title"\x3e{text}\x3c/span\x3e'+(a.desc?'\x3cspan class\x3d"link-desc"\x3e{desc}\x3c/span\x3e':"")+'\x3cspan class\x3d"link-link"\x3e'+(a.icon?'\x3cimg alt\x3d" " class\x3d"link-link-icon" data-cke-realelement\x3d"'+
encodeURIComponent('\x3cimg class\x3d"link-link-icon" alt\x3d" " src\x3d"'+a.icon+'"/\x3e')+'" src\x3d"{icon}"/\x3e':'\x3cimg data-cke-realelement\x3d"'+encodeURIComponent('\x3cimg class\x3d"link-link-icon" src\x3d"'+a.iconDefault+'"/\x3e')+'" src\x3d"{iconDefault}"/\x3e')+"{url}\x3c/span\x3e\x3c/span\x3e\x3c/a\x3e"},l=new CKEDITOR.template(l),k=function(a){return'\x3cspan class\x3d"link-card-box" contenteditable\x3d"false"\x3e\x3cspan class\x3d"link-title"\x3e{text}\x3c/span\x3e'+(a.desc?'\x3cspan class\x3d"link-desc"\x3e{desc}\x3c/span\x3e':
"")+'\x3cspan class\x3d"link-link"\x3e'+(a.icon?'\x3cimg alt\x3d" " class\x3d"link-link-icon" data-cke-realelement\x3d"'+encodeURIComponent('\x3cimg class\x3d"link-link-icon" alt\x3d" " src\x3d"'+a.icon+'"/\x3e')+'" src\x3d"{icon}"/\x3e':'\x3cimg data-cke-realelement\x3d"'+encodeURIComponent('\x3cimg class\x3d"link-link-icon" src\x3d"'+a.iconDefault+'"/\x3e')+'" src\x3d"{iconDefault}"/\x3e')+"{url}\x3c/span\x3e\x3c/span\x3e"},k=new CKEDITOR.template(k);CKEDITOR.addCss(".cke_widget_wrapper_has-card {  margin: 0 auto;  display: block;  width: 640px;  overflow: hidden;}.cke_widget_csdnlink.cke_widget_focused\x3e.cke_widget_element{  border: none;  outline: none;}.cke_widget_csdnlink\x3e.cke_widget_element{  display: inline;  color: #6795B5;  text-decoration: none;}.cke_widget_csdnlink\x3e.cke_widget_editable_focused {  outline: none !important;}.cke_widget_csdnlink\x3e.cke_widget_editable_focused.has-card .link-card-box{  border-color: #409EFF;}.cke_widget_csdnlink:hover\x3e.cke_widget_element{  cursor: text;  border: none;  outline: none !important;  color: #409EFF;  text-decoration: underline;}.cke_widget_csdnlink\x3e.cke_widget_element.has-card{  display: block;}.cke_widget_csdnlink\x3e.cke_widget_element.has-card:hover{  text-decoration: none!important;  color: unset;}.cke_widget_csdnlink .link-card-box{  margin: 8px auto 16px;  padding: 8px 16px;  display: block;  background: #F5F7FA;  border-radius: 4px;  border: 1px solid #DBDBDB;  cursor: pointer;}.cke_widget_csdnlink .link-card-box:hover{  border-color: #409EFF;}.cke_widget_csdnlink .link-card-box span{  display: block;}.cke_widget_csdnlink .link-card-box .link-title{  margin-bottom: 8px;  color: #222226;  overflow: hidden;  text-overflow: ellipsis;  white-space: nowrap;  font-size: 16px;  font-weight: 500;  line-height: 26px;}.cke_widget_csdnlink .link-card-box .link-desc{  display: -webkit-box;  -webkit-line-clamp: 2;  -webkit-box-orient: vertical;  margin-bottom: 8px;  max-height: 40px;  font-size: 14px;  font-weight: 400;  color: #999AAA;  line-height: 20px;  overflow: hidden;  word-break: break-all;}.cke_widget_csdnlink .link-card-box .link-link{  color: #409EFF;  overflow: hidden;  text-overflow: ellipsis;  white-space: nowrap;  font-size: 14px;  line-height: 1;  background-size: 14px 14px;  background-repeat: no-repeat;}.cke_widget_csdnlink .link-card-box .link-link img{  margin-right: 8px;  display: inline-block;  width: 14px;  height: 14px;  vertical-align: -2px;}");
e.widgets.add("csdnlink",{requiredContent:"a",mask:!1,draggable:!1,dialog:"csdnlinkDialog",defaults:{url:"",text:"",desc:"",icon:"",isCard:!1,hasResquest:!1,iconDefault:t,id:0},upcast:function(a){return"a"===a.name?(a=a.attributes.href)&&/^(http|https):\/\//.test(a):!1},styleableElements:"a",template:function(a){return a.isCard?l(a):'\x3ca class\x3d"link-info" href\x3d"{url}" title\x3d"{text}"\x3e{text}\x3c/a\x3e'},editables:{text:{selector:"a"}},parts:{text:"a"},data:function(){this.data.url&&this.element.setAttribute("href",
this.data.url);this.data.text&&(this.element.setText(this.data.text),this.element.setAttribute("title",this.data.text),this.element.setAttribute("data-link-title",this.data.text));this.data.desc&&this.element.setAttribute("data-link-desc",this.data.desc);this.data.icon?this.element.setAttribute("data-link-icon",this.data.icon):this.element.setAttribute("data-link-icon",this.data.iconDefault);if(this.data.isCard){var a=k.output(this.data);this.element.setHtml(a);this.inline=!0;e.fire("saveSnapshot")}},
init:function(){var a=this.element.getAttribute("href");if(this.inited&&null===a&&/^(http|https):\/\//.test(a)||this.inited&&!this.element.getText())return this.element.remove(),!1;var c=this,a=r()+"-"+Date.now();f[a]=null;this.setData("id",a);a=this.element.hasClass("has-card");this.setData("url",this.element.getAttribute("href"));this.setData("isCard",a);this.setData("text",this.element.getText());var a=this.element.getAttribute("data-link-title"),b=this.element.getAttribute("data-link-desc"),d=
this.element.getAttribute("data-link-icon");a&&(this.setData("text",a),this.setData("hasResquest",!0));b&&(this.setData("desc",b),this.setData("hasResquest",!0));d&&(this.setData("icon",d),this.setData("hasResquest",!0));this.element.on("input",function(){var a=c.element.getText();c.setData("text",a);if(""===a&&null!==f[c.data.id])this.remove(),f[c.data.id].remove(),f[c.data.id]=null;else{var a=e.container.findOne(".cke_wysiwyg_frame").$.offsetLeft,b=c.element.getDocumentPosition();f[c.data.id].setStyle("left",
a+b.x+c.wrapper.$.offsetWidth/2+"px")}e.fire("saveSnapshot")});this.data.hasResquest||(this.data.text===this.data.url&&q(this.data.url,this),this.setData("hasResquest",!0))},focusAfter:function(){var a=this;if(this.editor.config.csdnlink.disabled)return this.editor.on("key",function(b){b=b.data.keyCode;8!==b&&46!==b||!a.data.isCard||(a.element.removeAllListeners(),a.blurAfter(),a.wrapper.remove(),e.focus())}),!1;var c=this.element.getDocumentPosition();this.element.focus();if(null===f[this.data.id]){var b=
function(){f[a.data.id]&&(a.blurAfter(),e.focus());window.removeEventListener("scroll",b)};f[this.data.id]=p(c,this.data,this);window.addEventListener("scroll",b)}if(this.data.isCard&&(a=this,c=function(b){b=b.data.getKey();8===b||46===b?(a.element.removeAllListeners(),a.blurAfter(),a.wrapper.remove(),e.focus()):13===b&&(a.element.removeAllListeners(),a.blurAfter(),e.getCommand("accessNextSpace").exec(),e.focus())},!this.element.hasListeners("keydown")))this.element.on("keydown",c)},blurAfter:function(){f[this.data.id]&&
(f[this.data.id].remove(),f[this.data.id]=null)},focus:function(){this.element.getDocumentPosition();this.element.focus()}})}});