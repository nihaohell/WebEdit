/*
 Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
 For licensing, see LICENSE.md or http://ckeditor.com/license
*/
(function(){CKEDITOR.plugins.add("chart",{requires:"widget,dialog",icons:"chart",lang:"en,es,pl,zh-cn",icontype:".svg",iconoffset:"center",iconbgsize:"16px",hidpi:!1,afterInit:function(){var b=this;"undefined"===typeof Chart&&CKEDITOR.scriptLoader.load(CKEDITOR.getUrl(b.path+"lib/chart.min.js"),function(){b.drawCharts()})},init:function(b){var l=this,n=b.config.chart_height||300,f=b.config.chart_colors||{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,0.8)",highlightFill:"rgba(151,187,205,0.75)",
highlightStroke:"rgba(151,187,205,1)",data:"#B33131 #B66F2D #B6B330 #71B232 #33B22D #31B272 #2DB5B5 #3172B6 #3232B6 #6E31B2 #B434AF #B53071".split(" ")},h={Bar:b.config.chart_configBar||{animation:!1},Doughnut:b.config.chart_configDoughnut||{animateRotate:!1},Line:b.config.chart_configLine||{animation:!1},Pie:b.config.chart_configPie||{animateRotate:!1},PolarArea:b.config.chart_configPolarArea||{animateRotate:!1}},m=b.config.chart_maxItems||8;b.addContentsCss(CKEDITOR.getUrl(l.path+"chart.css"));
b.on("contentPreview",function(a){a.data.dataValue=a.data.dataValue.replace(/<\/head>/,'\x3cscript\x3evar chartjs_colors_json \x3d "'+JSON.stringify(f).replace(/\"/g,'\\"')+'";\x3c/script\x3e\x3cscript\x3evar chartjs_config_json \x3d "'+JSON.stringify(h).replace(/\"/g,'\\"')+'";\x3c/script\x3e\x3cscript src\x3d"'+CKEDITOR.getUrl(l.path+"lib/chart.min.js")+'"\x3e\x3c/script\x3e\x3cscript src\x3d"'+CKEDITOR.getUrl(l.path+"widget2chart.js")+'"\x3e\x3c/script\x3e\x3c/head\x3e')});CKEDITOR.dialog.add("chart",
function(a){for(var b={title:a.lang.chart.dialogTitle,minWidth:200,minHeight:100,resizable:CKEDITOR.DIALOG_RESIZE_NONE,onShow:function(){var d=a.widgets.focused;if(d)for(var b=0;b<m;b++)d.data.values[b]&&(this.setValueOf("data","value"+b,d.data.values[b].value.toString()),this.setValueOf("data","label"+b,d.data.values[b].label))},onOk:function(){for(var a=this.widget,b=[],c,e=0;e<m;e++)(c=this.getValueOf("data","value"+e))&&b.push({value:parseFloat(this.getValueOf("data","value"+e)),label:this.getValueOf("data",
"label"+e)});a.setData("values",b);a.setData("chart",this.getValueOf("data","chart"));a.setData("height",this.getValueOf("data","height"))},contents:[{id:"data",elements:[{type:"hbox",children:[{id:"chart",type:"select",label:a.lang.chart.chartType,labelLayout:"horizontal",labelStyle:"display:block;padding: 0 8px 4px 0;",items:[[a.lang.chart.bar,"bar"],[a.lang.chart.line,"line"],[a.lang.chart.pie,"pie"],[a.lang.chart.polar,"polar"],[a.lang.chart.doughnut,"doughnut"]],typeStyle:"border: 1px solid #CCCCCC;",
style:"background-color: #FFFFFF;font-size: 14px;color: #4D4D4D;",setup:function(a){this.setValue(a.data.chart)}},{id:"height",type:"text",label:a.lang.chart.height,labelLayout:"horizontal",labelStyle:"display:block;width:40px;float:right;",width:"100px",setup:function(a){this.setValue(a.data.height)},validate:function(){var b=this.getValue(),b=!b||!!(CKEDITOR.dialog.validate.number(b)&&0<=b);b||(alert(a.lang.common.validateNumberFailed),this.select());return b}}]}]}]},c=0;c<m;c++)b.contents[0].elements.push({type:"hbox",
children:[{id:"value"+c,type:"text",labelLayout:"horizontal",label:a.lang.chart.value,labelStyle:"display:block;padding: 0 8px 4px 0;",width:"50px",validate:function(){var b=this.getValue(),b=!b||!!(CKEDITOR.dialog.validate.number(b)&&0<=b);b||(alert(a.lang.common.validateNumberFailed),this.select());return b}},{id:"label"+c,type:"text",label:a.lang.chart.label,labelLayout:"horizontal",labelStyle:"display:block;padding: 0 6px;",width:"200px"}]});return b});this.drawCharts=function(){for(var a in b.widgets.instances)"chart"==
b.widgets.instances[a].name&&b.widgets.instances[a].fire("data")};b.widgets.add("chart",{button:b.lang.chart.chart,dialog:"chart",template:'\x3cdiv class\x3d"chartjs" data-chart\x3d"bar" data-chart-height\x3d"'+n+'"\x3e\x3ccanvas height\x3d"'+n+'"\x3e\x3c/canvas\x3e\x3cdiv class\x3d"chartjs-legend"\x3e\x3c/div\x3e\x3c/div\x3e',styleableElements:"div",pathName:"chart",toolbar:"insert,17",init:function(){this.element.data("chart-value")&&this.setData("values",JSON.parse(this.element.data("chart-value")));
this.setData("chart",this.element.data("chart"));this.setData("height",this.element.data("chart-height"));this.on("dialog",function(a){a.data.widget=this},this)},data:function(){if("undefined"!==typeof Chart&&this.data.values){var a=b.document.createElement("canvas",{attributes:{height:this.data.height}});a.replace(this.element.getChild(0));var e=this.element.getChild(1).$,a=a.$;if(a.getContext){var c=this.data,d=c.values,g=c.chart,a=a.getContext("2d"),k=new Chart(a);if("bar"!=g)for(a=0;a<d.length;a++)d[a].color=
f.data[a],d[a].highlight=f.data[a];if("bar"==g||"line"==g){c={datasets:[{label:"",fillColor:f.fillColor,strokeColor:f.strokeColor,highlightFill:f.highlightFill,highlightStroke:f.highlightStroke,data:[]}],labels:[]};for(a=0;a<d.length;a++)d[a].value&&(c.labels.push(d[a].label),c.datasets[0].data.push(d[a].value));e.innerHTML=""}"bar"==g?k.Bar(c,h.Bar):"line"==g?k.Line(c,h.Line):e.innerHTML="polar"==g?k.PolarArea(d,h.PolarArea).generateLegend():"pie"==g?k.Pie(d,h.Pie).generateLegend():k.Doughnut(d,
h.Doughnut).generateLegend()}}},allowedContent:"div(!chartjs)[data-*];",requiredContent:"div(chartjs)[data-chart-value,data-chart,data-chart-height]",upcast:function(a){if("div"==a.name&&a.hasClass("chartjs")){a.setHtml("");var b=new CKEDITOR.htmlParser.element("canvas",{height:a.attributes["data-chart-height"]});a.add(b);b=new CKEDITOR.htmlParser.element("div",{"class":"chartjs-legend"});a.add(b);return a}},downcast:function(a){var e=[];if(this.data.values){for(var c=0;c<this.data.values.length;c++)e.push({value:this.data.values[c].value,
label:this.data.values[c].label});return new CKEDITOR.htmlParser.element("div",{"class":a.attributes["class"],"data-chart":this.data.chart,"data-chart-height":this.data.height,"data-chart-value":b.getSelectedHtml?JSON.stringify(e):CKEDITOR.tools.htmlEncodeAttr(JSON.stringify(e))})}}})}})})();